<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="MITTI">

<title>Survey of Discharged Patients</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Survey_of_Discharged_Patients_files/libs/clipboard/clipboard.min.js"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-html/quarto.js"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-html/popper.min.js"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-html/anchor.min.js"></script>
<link href="Survey_of_Discharged_Patients_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Survey_of_Discharged_Patients_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Survey_of_Discharged_Patients_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Survey_of_Discharged_Patients_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Survey_of_Discharged_Patients_files/libs/bootstrap/bootstrap-a6af7324d27088d50edd0927bb2c6870.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/quarto-dashboard.js"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/stickythead.js"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/datatables.min.js" kdttablesentinel="true"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/pdfmake.min.js" kdttablesentinel="true"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/vfs_fonts.js" kdttablesentinel="true"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/web-components.js" type="module"></script>
<script src="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/components.js"></script>
<link href="Survey_of_Discharged_Patients_files/libs/quarto-dashboard/datatables.min.css" rel="stylesheet" kdttablesentinel="true">


</head>

<body class="quarto-dashboard dashboard-sidebar fullcontent">

<header id="quarto-dashboard-header">
<nav class="navbar navbar-expand-md slim" data-bs-theme="dark">
  <div class="navbar-container container-fluid">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#dashboard-collapse" aria-controls="dashboard-collapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>    


    <div class="navbar-brand-container">       

      <div class="navbar-title">
        <div class="navbar-title-text"><a href="#">Survey of Discharged Patients</a></div>
        
        <div class="navbar-author">MITTI</div>
      </div>
    </div>
<div id="dashboard-collapse" class="navbar-collapse collapse"><ul class="navbar-nav navbar-nav-scroll me-auto" role="tablist"><li class="nav-item" role="presentation"><a id="tab-基本情報" class="nav-link active" data-bs-toggle="tab" role="tab" data-bs-target="#基本情報" data-scrolling="true" href="#基本情報" aria-controls="基本情報" aria-selected="true"><span class="nav-link-text">基本情報</span></a></li><li class="nav-item" role="presentation"><a id="tab-mdc分析" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#mdc分析" data-scrolling="true" href="#mdc分析" aria-controls="mdc分析" aria-selected="false"><span class="nav-link-text">MDC分析</span></a></li><li class="nav-item" role="presentation"><a id="tab-ダウンロード" class="nav-link" data-bs-toggle="tab" role="tab" data-bs-target="#ダウンロード" data-scrolling="true" href="#ダウンロード" aria-controls="ダウンロード" aria-selected="false"><span class="nav-link-text">ダウンロード</span></a></li></ul></div></div>
</nav>
</header>
<div class="page-layout-custom quarto-dashboard-content bslib-gap-spacing html-fill-container dashboard-scrolling quarto-dashboard-pages dashboard-sidebar-container">  

<div class="bslib-sidebar-layout html-fill-item html-fill-container" data-bslib-sidebar-open="desktop" data-bslib-sidebar-init="true" data-bslib-sidebar-border="false" data-bslib-sidebar-border-radius="false"><div class="main html-fill-container html-fill-item"><div class="sidebar-content html-fill-item html-fill-container">
<div class="tab-content bslib-grid html-fill-item html-fill-container" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div id="基本情報" class="dashboard-page tab-pane show active html-fill-item html-fill-container" data-orientation="rows" aria-labelledby="tab-基本情報">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, 20fr) minmax(3em, 80fr); grid-auto-columns: minmax(0, 1fr);">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-columns: minmax(3em, 1fr);
grid-auto-rows: minmax(0, 1fr);">
<div class="card html-fill-item html-fill-container bslib-card" data-title="主病院" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-header"><div class="card-title html-fill-item html-fill-container"><span style="display: inline">
主病院
</span></div></div>
<div class="cell card-body html-fill-item html-fill-container">
<div class="cell-output-display html-fill-item html-fill-container">
<div id="main_hospital_text" class="shiny-text-output html-fill-item html-fill-container"></div>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
<div class="card tabset html-fill-item html-fill-container bslib-card" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-header bslib-navs-card-title"><div class="card-title html-fill-item html-fill-container"><span style="display: inline">

</span></div><ul class="nav nav-tabs card-header-tabs" role="tablist" data-tabsetid="card-tabset-2"><li class="nav-item" role="presentation"><a href="#card-tabset-2-1" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="平均在院日数" aria-selected="true" class="nav-link active">平均在院日数</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-2-2" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="救急医療入院" aria-selected="false" class="nav-link">救急医療入院</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-2-3" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="他院からの紹介の有無" aria-selected="false" class="nav-link">他院からの紹介の有無</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-2-4" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="入院経路と退院先" aria-selected="false" class="nav-link">入院経路と退院先</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-2-5" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="退院時転帰" aria-selected="false" class="nav-link">退院時転帰</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-2-6" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="再入院" aria-selected="false" class="nav-link">再入院</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-2-7" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="主要MDC" aria-selected="false" class="nav-link">主要MDC</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-2-8" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="在院日数分析" aria-selected="false" class="nav-link">在院日数分析</a></li></ul></div>








<div class="tab-content html-fill-item html-fill-container" data-tabset-id="card-tabset-2"><div class="tab-pane active show html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-1"><div class="card-body html-fill-item html-fill-container" data-title="平均在院日数">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_3" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-2"><div class="card-body html-fill-item html-fill-container" data-title="救急医療入院">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_6" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-3"><div class="card-body html-fill-item html-fill-container" data-title="他院からの紹介の有無">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_7" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-4"><div class="card-body html-fill-item html-fill-container" data-title="入院経路と退院先">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_8_patchwork" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-5"><div class="card-body html-fill-item html-fill-container" data-title="退院時転帰">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_9" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-6"><div class="card-body html-fill-item html-fill-container" data-title="再入院">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_10" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-7"><div class="card-body html-fill-item html-fill-container" data-title="主要MDC">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_12" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-2-8"><div class="card-body html-fill-item html-fill-container" data-title="在院日数分析">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data1_14" style="width:100%;height:400px;"></div>
</div>
</div></div></div><bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div><div id="mdc分析" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container" data-orientation="rows" aria-labelledby="tab-mdc分析">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, 1fr); grid-auto-columns: minmax(0, 1fr);">
<div class="card tabset html-fill-item html-fill-container bslib-card" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-header bslib-navs-card-title"><div class="card-title html-fill-item html-fill-container"><span style="display: inline">

</span></div><ul class="nav nav-tabs card-header-tabs" role="tablist" data-tabsetid="card-tabset-3"><li class="nav-item" role="presentation"><a href="#card-tabset-3-1" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="手術別MDC" aria-selected="true" class="nav-link active">手術別MDC</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-3-2" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="手術別MDC(市区町村)" aria-selected="false" class="nav-link">手術別MDC(市区町村)</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-3-3" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="緊急入院・救急車による搬送の有無" aria-selected="false" class="nav-link">緊急入院・救急車による搬送の有無</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-3-4" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="手術別MDC(主病院)" aria-selected="false" class="nav-link">手術別MDC(主病院)</a></li><li class="nav-item" role="presentation"><a href="#card-tabset-3-5" role="tab" data-toggle="tab" data-bs-toggle="tab" data-value="病名別　エリア分析" aria-selected="false" class="nav-link">病名別　エリア分析</a></li></ul></div>





<div class="tab-content html-fill-item html-fill-container" data-tabset-id="card-tabset-3"><div class="tab-pane active show html-fill-item html-fill-container" role="tabpanel" id="card-tabset-3-1"><div class="card-body html-fill-item html-fill-container" data-title="手術別MDC">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data2_2" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-3-2"><div class="card-body html-fill-item html-fill-container" data-title="手術別MDC(市区町村)">
<div class="cell-output-display html-fill-item html-fill-container">
<div style="overflow-x: auto;" class="html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data2_2_municipalities" style="width:100%;height:400px;"></div>
</div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-3-3"><div class="card-body html-fill-item html-fill-container" data-title="緊急入院・救急車による搬送の有無">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data2_3_4" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-3-4"><div class="card-body html-fill-item html-fill-container" data-title="手術別MDC(主病院)">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data2_8_main_hospital" style="width:100%;height:400px;"></div>
</div>
</div></div><div class="tab-pane html-fill-item html-fill-container" role="tabpanel" id="card-tabset-3-5"><div class="card-body html-fill-item html-fill-container" data-title="病名別　エリア分析">
<div class="cell-output-display html-fill-item html-fill-container">
<div class="shiny-plot-output html-fill-item html-fill-container" id="plot_data2_8_municipalities" style="width:100%;height:400px;"></div>
</div>
</div></div></div><bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
</div>
</div><div id="ダウンロード" class="dashboard-page tab-pane grid-skip html-fill-item html-fill-container" data-orientation="rows" aria-labelledby="tab-ダウンロード">
<div class="html-fill-item html-fill-container bslib-grid" style="display: grid; grid-template-rows: minmax(3em, 1fr); grid-auto-columns: minmax(0, 1fr);">
<div class="card cell html-fill-item html-fill-container bslib-card" data-title="ダウンロード" data-bslib-card-init="" data-require-bs-caller="card()" data-full-screen="false">
<div class="card-header"><div class="card-title html-fill-item html-fill-container"><span style="display: inline">
ダウンロード
</span></div></div>
<div class="card-body html-fill-item html-fill-container">
<div class="cell-output-display html-fill-item html-fill-container">
<a id="download_plot_all" class="btn btn-default shiny-download-link disabled" href="" target="_blank" download="" aria-disabled="true" tabindex="-1">
<i class="fas fa-download" role="presentation" aria-label="download icon"></i>
グラフをダウンロード
</a>
</div>
</div>
<bslib-tooltip placement="auto" bsoptions="[]" data-require-bs-version="5" data-require-bs-caller="tooltip()">
    <template>Expand</template>
    <span class="bslib-full-screen-enter badge rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="height:1em;width:1em;" aria-hidden="true" role="img"><path d="M20 5C20 4.4 19.6 4 19 4H13C12.4 4 12 3.6 12 3C12 2.4 12.4 2 13 2H21C21.6 2 22 2.4 22 3V11C22 11.6 21.6 12 21 12C20.4 12 20 11.6 20 11V5ZM4 19C4 19.6 4.4 20 5 20H11C11.6 20 12 20.4 12 21C12 21.6 11.6 22 11 22H3C2.4 22 2 21.6 2 21V13C2 12.4 2.4 12 3 12C3.6 12 4 12.4 4 13V19Z"></path></svg>
    </span>
</bslib-tooltip><script data-bslib-card-init="">bslib.Card.initializeAllCards();</script></div>
<div id="3ade8a4a-fb1d-4a6c-8409-ac45482d5fc9" class="hidden html-fill-item html-fill-container">

</div>
</div>
</div>
</div>
</div></div><aside id="bslib-sidebar-1" class="sidebar html-fill-container html-fill-item"><div class="html-fill-container html-fill-item">
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="prefecture-label" for="prefecture">都道府県</label>
<div>
<select id="prefecture" class="shiny-input-select"><option value="北海道" selected="">北海道</option>
<option value="青森県">青森県</option>
<option value="岩手県">岩手県</option>
<option value="宮城県">宮城県</option>
<option value="秋田県">秋田県</option>
<option value="山形県">山形県</option>
<option value="福島県">福島県</option>
<option value="茨城県">茨城県</option>
<option value="栃木県">栃木県</option>
<option value="群馬県">群馬県</option>
<option value="埼玉県">埼玉県</option>
<option value="千葉県">千葉県</option>
<option value="東京都">東京都</option>
<option value="神奈川県">神奈川県</option>
<option value="新潟県">新潟県</option>
<option value="富山県">富山県</option>
<option value="石川県">石川県</option>
<option value="福井県">福井県</option>
<option value="山梨県">山梨県</option>
<option value="長野県">長野県</option>
<option value="岐阜県">岐阜県</option>
<option value="静岡県">静岡県</option>
<option value="愛知県">愛知県</option>
<option value="三重県">三重県</option>
<option value="滋賀県">滋賀県</option>
<option value="京都府">京都府</option>
<option value="大阪府">大阪府</option>
<option value="兵庫県">兵庫県</option>
<option value="奈良県">奈良県</option>
<option value="和歌山県">和歌山県</option>
<option value="鳥取県">鳥取県</option>
<option value="島根県">島根県</option>
<option value="岡山県">岡山県</option>
<option value="広島県">広島県</option>
<option value="山口県">山口県</option>
<option value="徳島県">徳島県</option>
<option value="香川県">香川県</option>
<option value="愛媛県">愛媛県</option>
<option value="高知県">高知県</option>
<option value="福岡県">福岡県</option>
<option value="佐賀県">佐賀県</option>
<option value="長崎県">長崎県</option>
<option value="熊本県">熊本県</option>
<option value="大分県">大分県</option>
<option value="宮崎県">宮崎県</option>
<option value="鹿児島県">鹿児島県</option>
<option value="沖縄県">沖縄県</option></select>
<script type="application/json" data-for="prefecture" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="municipality_selector" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="hospital_main_selector" class="shiny-html-output"></div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="hospital_comparison_selector" class="shiny-html-output"></div>
</div>
<p>以下はMDC分析で使用</p>
<div class="cell-output-display">
<div class="form-group shiny-input-container no-baseline">
<label class="control-label" id="year_selector-label" for="year_selector">年度</label>
<input class="js-range-slider" id="year_selector" data-skin="shiny" data-min="2012" data-max="2022" data-from="2022" data-step="1" data-grid="true" data-grid-num="10" data-grid-snap="false" data-prettify-separator="," data-prettify-enabled="true" data-keyboard="true" data-data-type="number">
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="operation_selector-label" for="operation_selector">手術の有無</label>
<div>
<select id="operation_selector" class="shiny-input-select"><option value="手術あり">手術あり</option>
<option value="手術なし">手術なし</option>
<option value="合計" selected="">合計</option></select>
<script type="application/json" data-for="operation_selector" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div class="form-group shiny-input-container">
<label class="control-label" id="mdc_selector-label" for="mdc_selector">MDC</label>
<div>
<select id="mdc_selector" class="shiny-input-select"><option value="MDC01" selected="">MDC01</option>
<option value="MDC02">MDC02</option>
<option value="MDC03">MDC03</option>
<option value="MDC04">MDC04</option>
<option value="MDC05">MDC05</option>
<option value="MDC06">MDC06</option>
<option value="MDC07">MDC07</option>
<option value="MDC08">MDC08</option>
<option value="MDC09">MDC09</option>
<option value="MDC10">MDC10</option>
<option value="MDC11">MDC11</option>
<option value="MDC12">MDC12</option>
<option value="MDC13">MDC13</option>
<option value="MDC14">MDC14</option>
<option value="MDC15">MDC15</option>
<option value="MDC16">MDC16</option>
<option value="MDC17">MDC17</option>
<option value="MDC18">MDC18</option></select>
<script type="application/json" data-for="mdc_selector" data-nonempty="">{"plugins":["selectize-plugin-a11y"]}</script>
</div>
</div>
</div>
<div class="cell-output-display no-overflow-x">
<div id="disease_selector" class="shiny-html-output"></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>このサイトは厚生労働省の「DPC導入の影響評価に係る調査「退院患者調査」の結果報告」をもとに作成されています。</p>
<p>このプロジェクトは[公益社団法人 日本医業経営コンサルタント協会　令和6年度　情報活用コンペティション]に応募するために作成されました。 コンペティション期間中は、作品のライセンスに関しては特に明言しておらず、すべての権利は作者に帰属します。</p>
<p>予告なく公開を終了することがあります。</p>
</div>
</div>
</div>
</div></aside>
<button class="collapse-toggle" type="button" title="Toggle sidebar" aria-expanded="true" aria-controls="bslib-sidebar-1">
    <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 16 16" class="bi bi-chevron-left collapse-icon" style="fill:currentColor;" aria-hidden="true" role="img">
      <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"></path>
    </svg>
</button>
<script data-bslib-sidebar-init="">
bslib.Sidebar.initCollapsibleAll()
</script>
</div>
<p>
<script type="application/shiny-prerendered" data-context="server-start">
library(shiny)
library(data.table)
library(tidyverse)
library(tidylog)
library(DT)
library(gghighlight)
library(scales)
library(ggrepel)
library(patchwork)
library(quarto)
library(here)
# プロジェクトディレクトリを設定

options(shiny.maxRequestSize = 20 * 1024^2)

hospital_overview_long <- readRDS(here("rds", "hospital_overview_long.rds"))
setDT(hospital_overview_long)

disease_list <- readRDS(here("rds", "disease_list.rds"))

min_year <- min(hospital_overview_long$年度, na.rm = TRUE)
max_year <- max(hospital_overview_long$年度, na.rm = TRUE)  

prefectures <- readRDS(here("rds", "prefectures.rds"))
municipalities <- readRDS(here("rds", "municipalities.rds"))
hospitals <- readRDS(here("rds", "hospitals.rds"))
hospitals_municipalities <- readRDS(here("rds", "hospitals_municipalities.rds"))

# Load RDS files
rds_files <- list.files(path = here("data", "rds"), pattern = "\\.rds$", full.names = TRUE)

# Read all RDS files into a list and convert to data.tables
data_list <- lapply(rds_files, function(x) {
  dt <- setDT(readRDS(x))
  name <- gsub("\\.rds$", "", basename(x))  # Extract filename without extension
  return(dt)
})
names(data_list) <- gsub("\\.rds$", "", basename(rds_files)) # Assign names to list elements
</script>
 
<script type="application/shiny-prerendered" data-context="server">
output$municipality_selector <- renderUI({
  select_prefecture <- input$prefecture
  municipalities_for_prefecture <- municipalities[[select_prefecture]]
  selectInput("dynamicMunicipality", "市区町村", choices = municipalities_for_prefecture, multiple = FALSE, selectize = TRUE)
})

output$hospital_main_selector <- renderUI({
  select_municipality <- input$dynamicMunicipality
  if (is.null(select_municipality) || !select_municipality %in% names(hospitals_municipalities)) {
    return(selectInput("dynamicHospital_main", "主病院", choices = NULL))
  }
  hospitals_for_municipality <- hospitals_municipalities[[select_municipality]]
  if (is.null(hospitals_for_municipality) || length(hospitals_for_municipality) == 0) {
    return(selectInput("dynamicHospital_main", "主病院", choices = NULL))
  }
  selectInput("dynamicHospital_main", "主病院", choices = hospitals_for_municipality, multiple = FALSE, selectize = TRUE)
})

output$hospital_comparison_selector <- renderUI({
  select_prefecture <- input$prefecture
  hospitals_for_prefecture <- hospitals[[select_prefecture]]
  selectInput("dynamicHospital_comparison", "比較病院", choices = hospitals_for_prefecture, multiple = TRUE, selectize = TRUE)
})


output$disease_selector <- renderUI({
  mdc_selected <- input$mdc_selector
  disease_list_selected <- filter(disease_list, MDC_main == mdc_selected)
  selectInput("dynamicDisease", "病名", choices = disease_list_selected$label, multiple = FALSE)
})


# Create a reactive expression for filtered data_list
data_list_filtered <- reactive({
  lapply(data_list, function(dt) {
    if ("都道府県名" %in% names(dt)) {
      dt <- dt[都道府県名 == input$prefecture]
    }
    return(dt)
  })
})

output$main_hospital_text <- renderText({
  input$dynamicHospital_main
})

output$prefecture_text <- renderText({
  input$prefecture
})

output$municipality_text <- renderText({
  input$dynamicMunicipality
})

output$comparison_hospital_text <- renderText({
  input$dynamicHospital_comparison
})

output$download_plot_all <- downloadHandler(
  filename = function() {
    paste0("hospital_report_", input$dynamicHospital_main, "_", Sys.Date(), ".html")
  },
  content = function(file) {
    # 一時ディレクトリを作成
    temp_dir <- tempdir()
    
    # 現在の作業ディレクトリを記録
    orig_wd <- getwd()
    
    # 一時ディレクトリ内の一時ファイル
    temp_report <- file.path(temp_dir, "temp_report.qmd")
    temp_output <- file.path(temp_dir, "temp_report.html")
    
    # データの構造を確認
    if (!exists("data_list") || is.null(data_list)) {
      stop("データが正しく読み込まれていません")
    }
    
    # 必要なカラムが存在することを確認
    required_columns <- c("年度", "施設名_最新")
    for (dt_name in names(data_list)) {
      dt <- data_list[[dt_name]]
      if (!all(required_columns %in% names(dt))) {
        warning(sprintf("データテーブル %s に必要なカラムが存在しません", dt_name))
      }
    }
    
    # パラメータの設定
    params_list <- list(
      prefecture = input$prefecture,
      municipality = input$dynamicMunicipality,
      hospital_main = input$dynamicHospital_main,
      year = as.integer(max_year),
      operation = "合計"
    )
    
    # 操作タイプのパラメータを設定
    if (!is.null(input$operation_selector)) {
      params_list$operation <- input$operation_selector
    }
    
    # 年度パラメータを設定
    if (!is.null(input$year_slider_data1_14)) {
      params_list$year <- input$year_slider_data1_14
    } else if (!is.null(input$year_selector)) {
      params_list$year <- input$year_selector
    }
    
    # YAMLヘッダーの作成
    yaml_header <- c(
      "---",
      "title: \"Hospital Analysis Report\"",
      "author: \"MITTI\"",
      "format:",
      "  html:",
      "    toc: true",
      "    toc-depth: 3",
      "    number-sections: true",
      "    embed-resources: true",
      "    theme: default",
      "params:"
    )
    
    # パラメータYAML部分の作成
    params_yaml <- c(
      paste0("  prefecture: \"", params_list$prefecture, "\""),
      paste0("  municipality: \"", params_list$municipality, "\""),
      paste0("  hospital_main: \"", params_list$hospital_main, "\"")
    )
    
 
    
    # 残りのパラメータの追加
    params_yaml <- c(params_yaml,
                    paste0("  year: ", params_list$year),
                    paste0("  operation: \"", params_list$operation, "\""))
    
    # 完全なYAMLヘッダー
    full_yaml <- c(yaml_header, params_yaml, "---")
    
    # hospital_report.qmdの内容を読み込む
    report_content <- readLines(here("hospital_report.qmd"))
    
    # YAMLヘッダー部分を見つける
    yaml_end_idx <- which(report_content == "---")[2]
    
    if (length(yaml_end_idx) > 0 && !is.na(yaml_end_idx)) {
      # YAMLヘッダーを新しいものに置き換え
      modified_content <- c(
        full_yaml,
        report_content[(yaml_end_idx+1):length(report_content)]
      )
    } else {
      # YAMLセクションが見つからない場合は、そのまま使用
      modified_content <- c(
        full_yaml,
        report_content
      )
    }
    
    # 最後の行に改行を追加して完全なファイルにする
    modified_content <- c(modified_content, "")
    
    # 一時ファイルに書き込む
    writeLines(modified_content, temp_report)
    
    # コピーする必要のあるファイル - here::hereの挙動を一時ディレクトリでも正しく機能させるため
    dir.create(file.path(temp_dir, "rds"), showWarnings = FALSE, recursive = TRUE)
    dir.create(file.path(temp_dir, "data", "rds"), showWarnings = FALSE, recursive = TRUE)
    
    # .hereファイルを作成して一時ディレクトリをプロジェクトルートとして認識させる
    file.create(file.path(temp_dir, ".here"))
    
    # 必要なRDSファイルをコピー
    file.copy(
      from = list.files(here("rds"), full.names = TRUE), 
      to = file.path(temp_dir, "rds"), 
      recursive = TRUE
    )
    
    file.copy(
      from = list.files(here("data", "rds"), full.names = TRUE), 
      to = file.path(temp_dir, "data", "rds"), 
      recursive = TRUE
    )
    
    # 進行状況を通知
    showNotification("レポートをレンダリング中です。しばらくお待ちください...", type = "message", duration = NULL, id = "render_notif")
    
    # 作業ディレクトリを一時ディレクトリに変更
    setwd(temp_dir)
    
    # レポートをレンダリング
    tryCatch({
      # HTMLとして出力するように指定
      system2("quarto", args = c("render", "temp_report.qmd", "--to", "html", "--output", "temp_report.html"))
      
      # レンダリング成功したらファイルをコピー
      if (file.exists(temp_output)) {
        file.copy(temp_output, file, overwrite = TRUE)
        removeNotification("render_notif")
        showNotification("レポートが完成しました！", type = "message", duration = 5)
      } else {
        removeNotification("render_notif")
        showNotification("レポートの生成に失敗しました。", type = "error", duration = 10)
      }
    }, error = function(e) {
      removeNotification("render_notif")
      showNotification(paste("エラーが発生しました:", e$message), type = "error", duration = 10)
    }, finally = {
      # 元の作業ディレクトリに戻る
      setwd(orig_wd)
    })
  }
)




output$plot_data1_3 <- renderPlot({
  req(input$dynamicHospital_main)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison

  plot_data <- data_list_filtered()[["data1_3"]]
  plot_data$施設名_最新 <- fct_relevel(plot_data$施設名_最新, selected_hospital_main)

  if(is.null(plot_data)) return(NULL)

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data |>
    ggplot(aes(x = 年度, y = 平均値, group = 施設名_最新, color = 施設名_最新)) +
    geom_line(linewidth = 3) +
    gghighlight(
      施設名_最新 %in% highlight_hospitals, 
      use_direct_label = FALSE,
      unhighlighted_params = list(linewidth = 0.5)
    ) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(min_year, max_year, by = 1)) +
    labs(x = "", y = "平均在院日数", color = "", 
    caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（３）在院日数の状況』をもとに作成\n比較病院は同じ都道府県内の病院") +
    theme(legend.position = "top")
})


output$plot_data1_6 <- renderPlot({
  req(input$dynamicHospital_main)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison

  plot_data <- data_list_filtered()[["data1_6"]]
  plot_data$施設名_最新 <- fct_relevel(plot_data$施設名_最新, selected_hospital_main)

  if(is.null(plot_data)) return(NULL)

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data |>
    ggplot(aes(x = 年度, y = 率, group = 施設名_最新, color = 施設名_最新)) +
    geom_line(linewidth = 3) +
    gghighlight(
      施設名_最新 %in% highlight_hospitals,
      use_direct_label = FALSE,
      unhighlighted_params = list(linewidth = 0.5)
    ) +
    facet_wrap(~ key) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(min_year, max_year, by = 1)) +
    labs(x = "", y = "率", color = "",
         caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（６）救急医療入院』をもとに作成\n比較病院は同じ都道府県内の病院") +
    theme(legend.position = "top")
})

# 他院からの紹介の有無
output$plot_data1_7 <- renderPlot({
  req(input$dynamicHospital_main)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison

  plot_data <- data_list_filtered()[["data1_7"]]
  plot_data$施設名_最新 <- fct_relevel(plot_data$施設名_最新, selected_hospital_main)

  if(is.null(plot_data)) return(NULL)

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data |>
    ggplot(aes(x = 年度, y = 率, group = 施設名_最新, color = 施設名_最新)) +
    geom_line(linewidth = 3) +
    gghighlight(
      施設名_最新 %in% highlight_hospitals,
      use_direct_label = FALSE,
      unhighlighted_params = list(linewidth = 0.5)
    ) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(min_year, max_year, by = 1)) +
    labs(x = "", y = "他院からの紹介（率）", color = "",
         caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（７）他院よりの紹介の有無』をもとに作成\n比較病院は同じ都道府県内の病院") +
    theme(legend.position = "top")
})

# 入院経路と退院先をまとめて表示
output$plot_data1_8_patchwork <- renderPlot({
  req(input$dynamicHospital_main)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison

  plot_data <- data_list_filtered()[["data1_8_hospitalization"]]
  plot_data$施設名_最新 <- fct_relevel(plot_data$施設名_最新, selected_hospital_main)

  if(is.null(plot_data)) return(NULL)

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  # 入院経路のプロット
  plot_hospitalization <- {
    plot_data_hospitalization <- data_list_filtered()[["data1_8_hospitalization"]]
    plot_data_hospitalization$施設名_最新 <- fct_relevel(plot_data_hospitalization$施設名_最新, selected_hospital_main)

    if(is.null(plot_data_hospitalization)) return(NULL)

    plot_data_hospitalization |>
      filter(施設名_最新 %in% highlight_hospitals) |>
      filter(name != "家庭からの入院") |>
      mutate(label_value = ifelse(value >= 0.01, paste0(round(value * 100, 1), "%"), "")) |>
      ggplot(aes(x = 年度, y = value, fill = name)) +
      geom_bar(stat = "identity", position = "stack") +
      geom_text(aes(label = label_value), position = position_stack(vjust = 0.5)) +
      facet_wrap(~ 施設名_最新) +
      theme_minimal(base_family = "YuGothic", base_size = 20) +
      scale_x_continuous(breaks = seq(min_year, max_year, by = 1)) +
      scale_y_continuous(labels = scales::percent) +
      labs(x = "", y = "", fill = "", title = "入院経路") +
      theme(legend.position = "top", legend.text = element_text(size = 10), axis.text.x = element_text(angle = 90))
  }

  # 退院先のプロット
  plot_discharge <- {
    plot_data_discharge <- data_list_filtered()[["data1_8_discharge"]]
    plot_data_discharge$施設名_最新 <- fct_relevel(plot_data_discharge$施設名_最新, selected_hospital_main)

    if(is.null(plot_data_discharge)) return(NULL)

    plot_data_discharge |>
      filter(施設名_最新 %in% highlight_hospitals) |>
      filter(!grepl("家庭への退院", name)) |>
      mutate(label_value = ifelse(value >= 0.01, paste0(round(value * 100, 1), "%"), "")) |>
      ggplot(aes(x = 年度, y = value, fill = name)) +
      geom_bar(stat = "identity", position = "stack") +
      geom_text(aes(label = label_value), position = position_stack(vjust = 0.5)) +
      facet_wrap(~ 施設名_最新) +
      theme_minimal(base_family = "YuGothic", base_size = 20) +
      scale_x_continuous(breaks = seq(min_year, max_year, by = 1)) +
      scale_y_continuous(labels = scales::percent) +
      labs(x = "", y = "", fill = "", title = "退院先") +
      theme(legend.position = "top", legend.text = element_text(size = 10), axis.text.x = element_text(angle = 90))
  }

  # patchworkで結合し、共通のannotationを付与
  plot_hospitalization + plot_discharge +
    plot_annotation(
      caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（８）入院経路及び退院先の状況』をもとに作成\n比較病院は同じ都道府県内の病院\n入院経路は家庭からの入院/退院は家庭への退院を除いている",
      theme = theme(plot.caption = element_text(size = 12))
    )
})



output$plot_data1_9 <- renderPlot({
  req(input$dynamicHospital_main)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data_disposition <- data_list_filtered()[["data1_9"]]

  if(is.null(plot_data_disposition)) return(NULL)

  plot_data_disposition |>
    mutate(name = case_when(
      name %in% c("治癒", "軽快") ~ "治癒・軽快",
      TRUE ~ name
    )) |>
    #filter(name != "治癒・軽快") |>
    mutate(name = factor(name)) |>
    filter(施設名_最新 %in% highlight_hospitals) |>
    mutate(label_value = ifelse(value >= 0.01, paste0(round(value * 100, 1), "%"), "")) |>
    ggplot(aes(x = 年度, y = value, fill = name)) +
    geom_bar(stat = "identity", position = "stack") +
    geom_text(aes(label = label_value), position = position_stack(vjust = 0.5)) +
    facet_wrap(~ 施設名_最新) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(min_year, max_year, by = 1)) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = "", y = "", fill = "", title = "退院時転帰", caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（９）退院時転帰の状況』をもとに作成\n比較病院は同じ都道府県内の病院") +
    theme(legend.position = "top", legend.text = element_text(size = 10), axis.text.x = element_text(angle = 90))
})

output$plot_data1_10 <- renderPlot({
  req(input$dynamicHospital_main)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data_rehospitalization <- data_list_filtered()[["data1_10"]]

  if(is.null(plot_data_rehospitalization)) return(NULL)


  plot_data_rehospitalization |>
    filter(施設名_最新 %in% highlight_hospitals) |>
    mutate(施設名_最新 = fct_relevel(施設名_最新, highlight_hospitals)) |> # Specify the desired order of levels for 'key'
    mutate(label_value = ifelse(value >= 0.01, paste0(round(value * 100, 1), "%"), "")) |>
    ggplot(aes(x = 年度, y = value, fill = key, color = time)) +
    geom_bar(stat = "identity", position = "stack", alpha = 0.7) +
    geom_text(aes(label = label_value), position = position_stack(vjust = 0.5), color = "grey20") +
    facet_wrap(~ 施設名_最新) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(min_year, max_year, by = 1)) +
    scale_y_continuous(labels = scales::percent) +
    scale_color_manual(values = c("blue", "red")) +
    labs(x = "", y = "", fill = "", title = "再入院", caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（10）再入院の状況』をもとに作成\n比較病院は同じ都道府県内の病院\n期間：2015年までは6週囲内、2016年からは4週囲内") +
    theme(legend.position = "top", legend.text = element_text(size = 10), axis.text.x = element_text(angle = 90))
})

output$plot_data1_12 <- renderPlot({
  req(input$dynamicHospital_main)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data_subject <- data_list_filtered()[["data1_12"]]

  if(is.null(plot_data_subject)) return(NULL)


  plot_data_subject |>
    filter(施設名_最新 %in% highlight_hospitals) |>
    mutate(施設名_最新 = fct_relevel(施設名_最新, highlight_hospitals)) |> # Specify the desired order of levels for 'MDC'
    mutate(年度 = as.integer(年度)) |>
    group_by(施設名_最新, MDC) |>
    mutate(has_any_high_割合 = any(割合 >= 0.1)) |>
    ungroup() |>
    mutate(label_value = ifelse(割合 >= 0.1, paste0(round(割合 * 100, 1), "%"), "")) |>
    mutate(label_MDC = if_else((has_any_high_割合 & 年度 == max(年度)), paste0(MDC), "")) |>
    ggplot(aes(x = 年度, y = 割合, fill = MDC)) +
    geom_bar(stat = "identity", position = position_stack(reverse = TRUE)) +
    geom_text(aes(label = label_value), position = position_stack(vjust = 0.5, reverse = TRUE), color = "grey20") +
    geom_text_repel(aes(x = 年度 + 1, label = label_MDC), position = position_stack(vjust = 0.5, reverse = TRUE), color = "grey20", direction = "y") +
    facet_wrap(~ 施設名_最新, scales = "free_y") +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(as.integer(min_year), as.integer(max_year), by = 1)) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = "", y = "割合", fill = "", title = "退院時主診療科", caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（12）施設別MDC比率』をもとに作成\n比較病院は同じ都道府県内の病院\n割合が10%以上のMDCは表示している") +
    theme(legend.position = "none", legend.text = element_text(size = 10), axis.text.x = element_text(angle = 90))+
    coord_flip()
})



output$plot_data1_14 <- renderPlot({
  req(input$dynamicHospital_main, input$mdc_selector)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison
  selected_mdc <- input$mdc_selector

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data_animation <- data_list_filtered()[["data1_14"]]

  if(is.null(plot_data_animation)) return(NULL)


  plot_data_animation |>
    filter(施設名_最新 %in% highlight_hospitals) |>
    mutate(施設名_最新 = fct_relevel(施設名_最新, highlight_hospitals)) |>
    filter(MDC == selected_mdc) |>
    filter(!(is.na(患者構成の指標) | is.na(在院日数の指標))) |>
    ggplot(aes(x = 患者構成の指標, y = 在院日数の指標, color = 年度, label = 年度, group = 年度)) +
    geom_hline(yintercept = 1) +
    geom_vline(xintercept = 1) +
    geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
    geom_label_repel(aes(label = 年度), family = "YuGothic") +
    facet_wrap(~ 施設名_最新) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    labs(title = paste0("MDC: ", selected_mdc), x = "患者構成の指標", y = "在院日数の指標", caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（14）患者構成と在院日数の関係』をもとに作成\n比較病院は同じ都道府県内の病院") +
    theme(legend.position = "none", legend.text = element_text(size = 10))
})

### MDC分析

output$plot_data2_2 <- renderPlot({
  req(input$dynamicHospital_main, input$year_selector, input$operation_selector)

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison
  selected_year <- input$year_selector
  selected_operation <- input$operation_selector

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }

  plot_data_mdc_surgery <- data_list_filtered()[["data2_2"]]

  if(is.null(plot_data_mdc_surgery)) return(NULL)

 plot_data_mdc_surgery |> # Use filtered data
    filter(施設名_最新 %in% highlight_hospitals) |>
    mutate(施設名_最新 = fct_relevel(施設名_最新, highlight_hospitals)) |>
    filter(!is.na(value)) |>
    mutate(年度 = as.integer(年度)) |>
    mutate(n = sum(value), .by = c(施設名_最新, 手術, 年度)) |>
    group_by(施設名_最新, MDC, 手術) |>
    mutate(has_any_high_割合 = any(value/n >= 0.1)) |>
    ungroup() |>
    mutate(label_MDC = if_else((has_any_high_割合 & 年度 == max(年度)), paste0(MDC), "")) |>
    #mutate(施設名_最新 = forcats::fct_rev(施設名_最新)) |>
    ggplot(aes(x = 年度, y = value, fill = MDC)) +
    geom_bar(stat = "identity", position = position_stack(reverse = TRUE)) +
    geom_text_repel(aes(x = 年度 + 1, label = label_MDC), position = position_stack(vjust = 0.5, reverse = TRUE), color = "grey20", direction = "y") +
    facet_grid(施設名_最新 ~ 手術) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(as.integer(min_year), as.integer(max_year), by = 1)) +
    labs(x = "", y = "件数", fill = "", caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（２）MDC別医療機関別件数（割合）』をもとに作成\n比較病院は同じ都道府県内の病院\n割合が10%以上のMDCは表示している") +
    theme(legend.position = "none", legend.text = element_text(size = 10), axis.text.x = element_text(angle = 90))+
    coord_flip()
})


output$plot_data2_3_4 <- renderPlot({
  req(input$dynamicHospital_main, input$mdc_selector, input$year_selector) # Use mdc_selector and year_selector
  # req(input$mdc_slider) # Remove req for mdc_slider

  selected_hospital_main <- input$dynamicHospital_main
  selected_hospital_comparison <- input$dynamicHospital_comparison
  selected_mdc <- input$mdc_selector

  highlight_hospitals <- selected_hospital_main
  if (!is.null(selected_hospital_comparison) && length(selected_hospital_comparison) > 0) {
    highlight_hospitals <- c(selected_hospital_main, selected_hospital_comparison)
  }


  data2_4_dt <- setDT(copy(data_list_filtered()[["data2_4"]]))[MDC == selected_mdc]
  setnames(data2_4_dt, "救急車による搬送", "value")
  selected_cols <- c("市町村番号", "都道府県名", "市町村名", "施設名_最新", "lon", "lat", "年度", "施設名", "告示番号", "MDC", "value")
  data2_4_processed <- data2_4_dt[, ..selected_cols][, name := "救急車による搬送"]

  data2_3_dt <- setDT(copy(data_list_filtered()[["data2_3"]]))[MDC == selected_mdc]

  data2_3_4_join <-  rbind(data2_3_dt, data2_4_processed)
  setkey(data2_3_4_join, 市町村番号, 都道府県名, 市町村名, 施設名_最新, 年度)

  data2_3_4_join[, total_value := sum(value, na.rm = TRUE), by = .(施設名_最新, 年度, MDC)]
  data2_3_4_join[, proportion := value / total_value]
  data2_3_4_join <- data2_3_4_join[年度 >= 2013]


  data2_3_4_join |>
    tibble() |>
    filter(!is.na(proportion), !is.na(年度)) |>
    filter(name != "予定入院") |>
    mutate(施設名_最新 = fct_relevel(施設名_最新, highlight_hospitals)) |>
    ggplot(aes(x = 年度, y = proportion, group = 施設名_最新, color = 施設名_最新)) +
    geom_line(linewidth = 3) +
    gghighlight(
      施設名_最新 %in% highlight_hospitals,
      use_direct_label = FALSE,
      unhighlighted_params = list(linewidth = 0.5)
    ) +
    facet_wrap(~ name) +
    theme_minimal(base_family = "YuGothic", base_size = 20) +
    scale_x_continuous(breaks = seq(2013, max_year, by = 1)) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = "", y = "", color = "", caption = paste0("出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（３）予定・救急医療入院医療機関別MDC別集計, （４）救急車による搬送の有無の医療機関別MDC別集計』をもとに作成\n比較病院は同じ都道府県内の病院")) +
    theme(legend.position = "top")
})

output$plot_data2_8_main_hospital <- renderPlot({
  req(input$year_selector, input$operation_selector, input$dynamicHospital_main) # Use year_selector and operation_selector
  # req(input$year_slider_data2_8)
  # req(input$column_select_data2_8)
  req(input$dynamicHospital_main)

  validate(
    need(input$operation_selector %in% c("手術あり", "手術なし", "合計"), # Use operation_selector
         "Invalid column selection")
  )

  selected_hospital_main <- input$dynamicHospital_main
  selected_year_data2_8 <- input$year_selector # input$year_slider_data2_8
  selected_column_data2_8 <- input$operation_selector # input$column_select_data2_8

  DT_data2_8 <- setDT(copy(data_list_filtered()[["data2_8"]]))
  DT_data2_8_filtered <- DT_data2_8[年度 == selected_year_data2_8]
  DT_data2_8_filtered <- DT_data2_8_filtered[施設名_最新 %in% c(selected_hospital_main)]

  DT_data2_8_filtered_plot <- DT_data2_8_filtered |>
    filter(!!sym(selected_column_data2_8) > 0) |>
    arrange(施設名_最新, 年度, desc(!!sym(selected_column_data2_8) )) |>
    mutate(percentage = !!sym(selected_column_data2_8)/sum(!!sym(selected_column_data2_8)), .by = c(施設名_最新, 年度)) |>
    mutate(cumsum_percentage = cumsum(percentage), .by = c(施設名_最新, 年度)) |>
    mutate(group_size = rank(desc(!!sym(selected_column_data2_8))), .by = c(施設名_最新, 年度)) |>
    mutate(value = !!sym(selected_column_data2_8)) |>
    filter(group_size <= 20)

  ggplot(DT_data2_8_filtered_plot, aes(x = reorder(paste0(病名, " (", MDC_main, ")"), desc(cumsum_percentage)), group = 施設名_最新)) +
    geom_bar(aes(y = percentage, fill = MDC_main), stat = "identity") +
    geom_line(aes(y = cumsum_percentage), linewidth = 3, color = "red") +
    geom_text(aes(label = value, y = percentage), family = "YuGothic", size = 5, hjust = -0.5) +
    theme_minimal(base_family = "YuGothic", base_size = 14) +
    scale_y_continuous(labels = scales::percent) +
    labs(x = "", y = "", color = "", caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（８）疾患別手術別集計』をもとに作成\n上位20位までを表示している") +
    coord_flip()
    #theme(legend.position = "right", axis.text.x = element_text(angle = 90))
})


output$plot_data2_8_municipalities <- renderPlot({
  req(input$dynamicMunicipality, input$dynamicDisease)
  
  selected_prefecture <- input$prefecture
  selected_municipality <- input$dynamicMunicipality
  selected_operation <- input$operation_selector
  selected_disease <- input$dynamicDisease # Use the full label "病名(MDC)"
  selected_disease_label <- disease_list$病名[disease_list$label == selected_disease]


  DT_for_plot <- setDT(copy(data_list_filtered()[["data2_8"]]))
  DT_for_plot <- mutate(DT_for_plot, value = !!sym(selected_operation))
  
  DT_for_plot <- DT_for_plot[病名 == selected_disease_label] # Filter by the full disease label
  DT_for_plot <- DT_for_plot[value > 0]

  DT_for_plot <- DT_for_plot[市町村名 == selected_municipality]
  DT_for_plot[, 年度別割合 := value / sum(value), by = 年度]


  ggplot(DT_for_plot, aes(x = 年度, y = 施設名_最新, fill = 年度別割合*100, label = paste0(value, "件\n", round(年度別割合*100, 1), "%"))) +
    geom_tile() +
    geom_text() +
    theme_minimal(base_family = "YuGothic", base_size = 14) +
    scale_fill_gradient(low = "white", high = "red") +
    labs(x = "", y = "", fill = "地域別割合(%)", title = paste0(selected_disease, "_", selected_operation, "(", selected_prefecture, selected_municipality, ")"), caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（８）疾患別手術別集計』をもとに作成\n市区町村単位で表示") +
    theme(legend.position = "top")
})


output$plot_data2_2_municipalities <- renderPlot({
  req(input$dynamicMunicipality, input$mdc_selector, input$prefecture, input$operation_selector)

  selected_prefecture <- input$prefecture
  selected_municipality <- input$dynamicMunicipality
  selected_operation <- input$operation_selector
  selected_mdc <- input$mdc_selector

  DT <- setDT(copy(data_list_filtered()[["data2_2"]]))
  DT_casted <- dcast(DT, 年度 + 市町村名 + MDC + 市町村番号 + 都道府県名 + 施設名_最新 ~ 手術, value.var = "value", fun.aggregate = sum, fill = 0)
  setnames(DT_casted, old = c("有り", "無し"), new = c("手術あり", "手術なし"))
  DT_casted[, `手術あり` := fcoalesce(`手術あり`, 0L)]
  DT_casted[, `手術なし` := fcoalesce(`手術なし`, 0L)]
  DT_casted[, 合計 := `手術あり` + `手術なし`]


  DT_casted <- mutate(DT_casted, value = !!sym(selected_operation))

  DT_casted <- DT_casted[MDC == selected_mdc] # Filter by MDC, use MDC instead of MDC_main
  DT_casted <- DT_casted[value > 0]
  DT_casted <- DT_casted[市町村名 == selected_municipality]

  DT_casted <- DT_casted[, 年度別割合 := value / sum(value), by = 年度]


  ggplot(DT_casted, aes(x = as.integer(年度), y = 施設名_最新, fill = 年度別割合*100, label = paste0(value, "件(", round(年度別割合*100, 1), "%", ")"))) +
    geom_tile() +
    geom_text() +
    theme_minimal(base_family = "YuGothic", base_size = 14) +
    scale_fill_gradient(low = "white", high = "red") +
    scale_x_continuous(breaks = seq(as.integer(min_year), as.integer(max_year), by = 1)) +
    labs(x = "", y = "", fill = "割合(%)", title = paste0(selected_mdc, "_", selected_operation, "(", selected_municipality, ")"), caption = "出典: 厚生労働省DPC導入の影響評価に係る調査「退院患者調査」の結果報告\n『（２）MDC別医療機関別件数（割合）』をもとに作成\n市区町村単位で表示") + # Updated caption to data2_2 and municipality
    theme(legend.position = "top")
})









</script>
 
<script type="application/shiny-prerendered" data-context="server-extras">
ojs_define <- function(..., .session = shiny::getDefaultReactiveDomain()) {
  quos <- rlang::enquos(...)
  vars <- rlang::list2(...)
  nm <- names(vars)
  if (is.null(nm)) {
    nm <- rep_len("", length(vars))
  }
  mapply(function(q, nm, val) {
    # Infer name, if possible
    if (nm == "") {
      tryCatch({
        nm <- rlang::as_name(q)
      }, error = function(e) {
        code <- paste(collapse = "\n", deparse(rlang::f_rhs(q)))
        stop("ojs_define() could not create a name for the argument: ", code)
      })
    }
    .session$output[[nm]] <- val
    outputOptions(.session$output, nm, suspendWhenHidden = FALSE)
    .session$sendCustomMessage("ojs-export", list(name = nm))
    NULL
  }, quos, nm, vars, SIMPLIFY = FALSE, USE.NAMES = FALSE)
  invisible()
}
</script>
</p>
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="dependencies">
{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.9.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["ionrangeslider-javascript"]},{"type":"character","attributes":{},"value":["2.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/ionrangeslider"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/ion.rangeSlider.min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.9.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["strftime"]},{"type":"character","attributes":{},"value":["0.9.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/strftime"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["strftime-min.js"]},{"type":"NULL"},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.9.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["ionrangeslider-css"]},{"type":"character","attributes":{},"value":["2.3.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/ionrangeslider"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/ion.rangeSlider.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.9.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.9.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["selectize"]},{"type":"character","attributes":{},"value":["0.15.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["www/shared/selectize"]}]},{"type":"NULL"},{"type":"character","attributes":{},"value":["js/selectize.min.js","accessibility/js/selectize-plugin-a11y.min.js"]},{"type":"character","attributes":{},"value":["css/selectize.bootstrap3.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["shiny"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["1.9.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["htmltools-fill"]},{"type":"character","attributes":{},"value":["0.5.8.1"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fill"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fill.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["htmltools"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.8.1"]}]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","version","src","meta","script","stylesheet","head","attachment","package","all_files","pkgVersion"]},"class":{"type":"character","attributes":{},"value":["html_dependency"]}},"value":[{"type":"character","attributes":{},"value":["font-awesome"]},{"type":"character","attributes":{},"value":["6.4.2"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["file"]}},"value":[{"type":"character","attributes":{},"value":["fontawesome"]}]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["css/all.min.css","css/v4-shims.min.css"]},{"type":"NULL"},{"type":"NULL"},{"type":"character","attributes":{},"value":["fontawesome"]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["0.5.2"]}]}]}
</script>
<!--/html_preserve-->
<!--html_preserve-->
<script type="application/shiny-prerendered" data-context="execution_dependencies">
{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["packages","version"]},"class":{"type":"character","attributes":{},"value":["data.frame"]},"row.names":{"type":"integer","attributes":{},"value":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80]}},"value":[{"type":"character","attributes":{},"value":["base","bslib","cachem","cli","clisymbols","colorspace","compiler","data.table","datasets","digest","dplyr","DT","evaluate","fansi","farver","fastmap","fontawesome","forcats","generics","gghighlight","ggplot2","ggrepel","glue","graphics","grDevices","grid","gtable","here","hms","htmltools","htmlwidgets","httpuv","jquerylib","jsonlite","knitr","later","lifecycle","lubridate","magrittr","memoise","methods","mime","munsell","patchwork","pillar","pkgconfig","processx","promises","ps","purrr","quarto","R6","Rcpp","readr","renv","rlang","rmarkdown","rprojroot","rstudioapi","sass","scales","shiny","stats","stringi","stringr","tibble","tidylog","tidyr","tidyselect","tidyverse","timechange","tools","tzdb","utf8","utils","vctrs","withr","xfun","xtable","yaml"]},{"type":"character","attributes":{},"value":["4.4.0","0.7.0","1.1.0","3.6.3","1.2.0","2.1-1","4.4.0","1.16.0","4.4.0","0.6.36","1.1.4","0.33","0.24.0","1.0.6","2.1.2","1.2.0","0.5.2","1.0.0","0.1.3","0.4.1","3.5.1","0.9.6","1.7.0","4.4.0","4.4.0","4.4.0","0.3.5","1.0.1","1.1.3","0.5.8.1","1.6.4","1.6.15","0.1.4","1.8.8","1.47","1.3.2","1.0.4","1.9.3","2.0.3","2.0.1","4.4.0","0.12","0.5.1","1.3.0","1.9.0","2.0.3","3.8.4","1.3.0","1.8.0","1.0.2","1.4.4","2.5.1","1.0.13","2.1.5","1.1.0","1.1.4","2.28","2.0.4","0.16.0","0.4.9","1.3.0","1.9.1","4.4.0","1.8.4","1.5.1","3.2.1","1.1.0","1.3.1","1.2.1","2.0.0","0.3.0","4.4.0","0.4.0","1.2.4","4.4.0","0.6.5","3.0.1","0.45","1.8-4","2.3.8"]}]}]}
</script>
<!--/html_preserve-->


<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /container fluid -->

<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (_event) {
  if (window.bslib.Card) {
    window.bslib.Card.initializeAllCards();
  }
}); 
</script>
  



</body></html>